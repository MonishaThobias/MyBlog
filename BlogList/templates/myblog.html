{% extends 'master.html' %}
{% load static %}

{% block title %}Blog Lists - My Blog{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog_list.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="my-5 text-center">
        <h3>The Feed</h3>
    </div>

    <div class="row my-5">
        <div class="col custom-link">
            <a href="#"><h4>All Posts</h4></a>
        </div>
        <div class="col text-end">
            <button class="btn custom-btn" data-bs-toggle="modal" data-bs-target="#signupModal">Login / Sign up</button>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-4 my-4">
        {% for post in posts %}
        <div class="col">
            <div class="card h-100">
                <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}">
                <div class="card-body custom-post-content">
                    <small class="text-muted">{{ post.created_date }} - {{ post.created_time }}</small>
                    <a href="{% url 'blog_detail' post.id %}" >
                        <h5 class="card-title mt-2">{{ post.title }}</h5>
                        <p class="card-text">{{ post.content|truncatechars:200 }}</p>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Signup Modal -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="signupModalLabel">Sign Up</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        
        <form method="post" action="{% url 'signup' %}">
          {% csrf_token %}
          {{ signup_form.non_field_errors }}

          <div class="mb-3">
            {{ signup_form.username.label_tag }}
            {{ signup_form.username }}
            {{ signup_form.username.errors }}
          </div>

          <div class="mb-3">
            {{ signup_form.email.label_tag }}
            {{ signup_form.email }}
            {{ signup_form.email.errors }}
          </div>

          <div class="mb-3">
            {{ signup_form.password1.label_tag }}
            {{ signup_form.password1 }}
            {{ signup_form.password1.errors }}
          </div>

          <div class="mb-3">
            {{ signup_form.password2.label_tag }}
            {{ signup_form.password2 }}
            {{ signup_form.password2.errors }}
          </div>

          <button type="submit" class="btn btn-primary w-100">Sign Up</button>

          <p class="mt-3 text-center">Already have an account?
            <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Login Here</a>
          </p>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Log In</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form method="post" action="{% url 'login' %}">
          {% csrf_token %}
          {{ login_form.non_field_errors }}

          {{ login_form.username.label_tag }}
          {{ login_form.username }}
          {{ login_form.username.errors }}

          {{ login_form.password.label_tag }}
          {{ login_form.password }}
          {{ login_form.password.errors }}

          <button type="submit" class="btn btn-primary w-100 mt-3">Log In</button>

          <p class="mt-3 text-center">Don't have an account yet?
            <a href="#" data-bs-toggle="modal" data-bs-target="#signupModal" data-bs-dismiss="modal">Signup Here</a>
          </p>
        </form>
      </div>

    </div>
  </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const signupForm = document.querySelector('#signupModal form');
  if (signupForm) {
    signupForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      // Clear previous alerts
      document.querySelectorAll('.alert').forEach(el => el.remove());

      const formData = new FormData(signupForm);
      const csrfToken = formData.get('csrfmiddlewaretoken');

      const response = await fetch("{% url 'signup' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        // Show success alert inside modal or elsewhere
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success mt-3';
        successAlert.innerText = result.message;
        signupForm.prepend(successAlert);

        // Reset form fields
        signupForm.reset();

        // Optionally close the modal after a delay
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('signupModal'));
          modal.hide();
          // Or reload page: location.reload();
        }, 2000);

      } else {
        // Show validation errors
        for (let field in result.errors) {
          result.errors[field].forEach(error => {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.innerText = `${field}: ${error.message}`;
            signupForm.prepend(errorDiv);
          });
        }
      }
    });
  }
});

document.addEventListener('DOMContentLoaded', function () {
  const loginForm = document.querySelector('#loginModal form');
  if (loginForm) {
    loginForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      // Remove old error messages if any
      document.querySelectorAll('.alert').forEach(el => el.remove());

      const formData = new FormData(loginForm);
      const csrfToken = formData.get('csrfmiddlewaretoken');

      const response = await fetch("{% url 'login' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        // Redirect on successful login
        window.location.href = result.redirect_url || '/';
      } else {
        // Display errors inside the modal
        let errorHtml = '';
        if (result.errors) {
          for (let field in result.errors) {
            result.errors[field].forEach(error => {
              errorHtml += `<div class="alert alert-danger">${field}: ${error.message}</div>`;
            });
          }
        } else if (result.message) {
          errorHtml = `<div class="alert alert-danger">${result.message}</div>`;
        }
        loginForm.insertAdjacentHTML('beforebegin', errorHtml);
      }
    });
  }
});

</script>
{% endblock extra_js %}

